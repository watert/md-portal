<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>
		统一Portal | Markdown based editable Portal.
	</title>
	<script src="libs/jquery-1.7.1.min.js"></script>
	<script src="libs/underscore+backbone.js"></script>
	<!-- Bootstrap -->
	<link rel="stylesheet" href="libs/bootstrap2/css/bootstrap.min.css">
	<link rel="stylesheet" href="libs/bootstrap2/css/bootstrap-responsive.css">
	<script src="libs/bootstrap2/js/bootstrap.min.js"></script>
	<script src="libs/bootstrap.quickform.js"></script>
	<link rel="stylesheet/less" href="libs/bootstrap.mod.less">
	
	<script src="libs/jQuery.lightDataBind.js"></script>
	<script src="libs/markdown.js"></script>

	<script src="classes.js"></script>
	<script>

		var init = (function(){
			var App = window.App;
			var model = App.initModel();
			var tmplActions = '<p class="actions"><a href="" class="btn btn-mini btn-edit">Edit</a></p>';

			var updateDom = function updateDom($el){
				var key = $el.attr("data-markdown");
				var value = App.model.get(key);
				var content = $("<div>",{"class":"md-content"})
				$el.empty();
				if(!value){
					value="*Empty*";
					content.addClass("muted");
				}
				var html = markdown.toHTML(value);
				content.append(html).appendTo($el);
				$el.append(tmplActions);
			};
			var editForm = $(".md-edit-form");
			var editMarkdown = function editMarkdown($el){	
				var key = $el.attr("data-markdown");
				var content = App.model.get(key);
				var data = {
					key:key,
					content:content||""
				};
				editForm.ldatabind(data);
				editForm.quickmodal({
					title:editForm.attr("title"),
					actions:{
						Save:function(){
							var _data = editForm.ldata();
							var data = {};data[key] = _data.content;
							App.model.save(data,{success:function(){
								App.model.trigger("sync");
							}});	
							editForm.quickmodal("hide");
						},
						Cancel:function(){
							editForm.quickmodal("hide");
						}
					}
				});
			}

			$("[data-markdown]").each(function(){
				var el = this,
					$el = $(this);
				App.model.on("sync",function(){
					updateDom($el,model);
				});
				$el.on("click",".btn-edit",function(e){
					e.preventDefault();
					editMarkdown($el);
				});
			});
		});
	</script>
	<link rel="stylesheet/less" href="style.less">
	<script src="libs/less-1.2.2.min.js"></script>
</head>
<body>
	<div class="container">
		<h1 class="page-header"> MD-Portal </h1>
		<div id="content">
			
		</div>
		<script>
			$("#content").load("layouts/portal.html",function(){
				init();
			});
		</script>
	</div>



	<!--  Form (Hidden) -->
	<div class="md-edit-form hide" title="Edit Form">
		<form action="" class="form">
			<pre data-text="key"></pre>
			<label for="">Markdown</label>
			<textarea name="content" data-value="content" class="input-block-level" rows="5"></textarea>
		</form>
	</div>
</body>
</html>