<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>
		统一Portal | Markdown based editable Portal.
	</title>
	<script src="libs/jquery-1.7.1.min.js"></script>
	<script src="libs/underscore+backbone.js"></script>
	<!-- Bootstrap -->
	<link rel="stylesheet" href="libs/bootstrap2/css/bootstrap.min.css">
	<link rel="stylesheet" href="libs/bootstrap2/css/bootstrap-responsive.css">
	<script src="libs/bootstrap2/js/bootstrap.min.js"></script>
	<script src="libs/bootstrap.quickform.js"></script>
	<link rel="stylesheet/less" href="libs/bootstrap.mod.less">
	
	<script src="libs/jQuery.lightDataBind.js"></script>
	<script src="libs/markdown.js"></script>

	<script>
		window.App = {};
		$(function(){
			var model = new Backbone.Model({
				id:"md-portal",
				subtitle:"test Subtitle"
			});
			model.url = "data/file_rest.php?f=md-portal.json"
			App.model = model;
			model.fetch({
				success:function(){
					model.trigger("sync");
				}
			});

			var tmplActions = '<p class="actions"><a href="" class="btn btn-mini btn-edit">Edit</a></p>';
			var updateDom = function updateDom($el){
				var key = $el.attr("data-markdown");
				var value = App.model.get(key);
				var content = $("<div>",{"class":"md-content"})
				$el.empty();
				if(!value){
					value="*Empty*";
					content.addClass("muted");
				}
				var html = markdown.toHTML(value);
				content.append(html).appendTo($el);
				$el.append(tmplActions);
			};
			var editForm = $(".md-edit-form");
			var editMarkdown = function editMarkdown($el){	
				var key = $el.attr("data-markdown");
				var content = App.model.get(key);
				var data = {
					key:key,
					content:content||""
				};
				editForm.ldatabind(data);
				console.log(data,editForm);
				editForm.quickmodal({
					title:editForm.attr("title"),
					actions:{
						Save:function(){
							var _data = editForm.ldata();
							var data = {};data[key] = _data.content;
							App.model.save(data,{success:function(){
								App.model.trigger("sync");
							}});	
							editForm.quickmodal("hide");
						},
						Cancel:function(){
							editForm.quickmodal("hide");
						}
					}
				});
			}

			$("[data-markdown]").each(function(){
				var el = this,
					$el = $(this);
				App.model.on("sync",function(){
					updateDom($el,model);
				});
				$el.on("click",".btn-edit",function(e){
					e.preventDefault();
					editMarkdown($el);
				});
			});
		});
	</script>
	<style type="text/less">
		[data-markdown] {
			position:relative;
			p {margin:0.2em 0;}
			.actions {position:absolute;right:2px;bottom:2px;margin:0;
				.btn-edit {visibility: hidden;}	
			}
			&:hover { 
				.actions .btn-edit {visibility: visible;}
			}
		}
		.page-header { margin-bottom:14px; }
		.footer {margin-top:4em;padding:1em;background:#F5f5f5;font-family: Georgia;}
		textarea {font-family:consolas;}
	</style>
	<script src="libs/less-1.2.2.min.js"></script>
</head>
<body>
	<div class="container">
		<h1 class="page-header"> MD-Portal </h1>

		<div class="row">
			<div class="span8">
				<section data-markdown="subtitle">
					
				</section>
				<br>
				<div class="row-fluid">
					<div class="span4">
						<section data-markdown="first-row-span1"></section>
					</div>
					<div class="span4">
						<section data-markdown="first-row-span2"></section>
					</div>
					<div class="span4">
						<section data-markdown="first-row-span3"></section>
					</div>
				</div>
				<hr>
				<div class="row-fluid">
					<div class="span4">
						<section data-markdown="2nd-row-span1"></section>
					</div>
					<div class="span4">
						<section data-markdown="2nd-row-span2"></section>
					</div>
					<div class="span4">
						<section data-markdown="2nd-row-span3"></section>
					</div>
				</div>
			</div>
			<div class="span4">
				<section class="alert alert-warning" data-markdown="side-row">
					
				</section>
				<div class="mod">
					<div class="mod-body">
						<section data-markdown="side-row-2"></section>
					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="footer text-center">
		<div class="container">
			<section class="muted" data-markdown="footer">
				
			</section>
		</div>
	</div>

	<!--  Form (Hidden) -->
	<div class="md-edit-form hide" title="Edit Form">
		<form action="" class="form">
			<pre data-text="key"></pre>
			<label for="">Markdown</label>
			<textarea name="content" data-value="content" class="input-block-level" rows="5"></textarea>
		</form>
	</div>
</body>
</html>